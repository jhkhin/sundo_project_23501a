<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.postgres.sample.service.impl.dao.kjo.Kjo_CheckReportDAO">
    <select id="cntByFacilityCode" parameterType="checkReport" resultType="checkReport">
        select count(*) as total from check_report where facility_code = #{facility_code}
    </select>

    <select id="cntAllReport" resultType="checkReport">
        select count(*) as total from check_report
    </select>

    <insert id="inputChkReport" parameterType="checkReport">
        insert into check_report
        values (#{doc_no},#{facility_code},#{check_date}::date,
                #{weather},#{user_id},#{check_result},#{spec_memo},current_date,current_date)
    </insert>
    <select id="findChkReport" parameterType="checkReport" resultType="checkReport">
        select * from
            (
                select row_number() over() as rn,ui.user_name, cr.*, wr.facility_category , org.org_name, ar.org_area_name
                from check_report cr join water_resources wr
                                          on cr.facility_code = wr.facility_code
                                     INNER JOIN org_area ar ON  wr.org_area =ar.org_area
                                     INNER JOIN ORGANIZATION org ON  wr.org_code =org.org_code
                                     INNER JOIN user_info ui ON  cr.user_id =ui.user_id
                order by rn
            )
    </select>
    <select id="pageChkReport" parameterType="checkReport" resultType="checkReport">
        select * from
            (
                select row_number() over() as rn,ui.user_name, cr.*, wr.facility_category , org.org_name, ar.org_area_name
                from check_report cr join water_resources wr
                                          on cr.facility_code = wr.facility_code
                                     INNER JOIN org_area ar ON  wr.org_area =ar.org_area
                                     INNER JOIN ORGANIZATION org ON  wr.org_code =org.org_code
                                     INNER JOIN user_info ui ON  cr.user_id =ui.user_id
                order by rn
            )
        offset #{start} limit 10
    </select>


    <select id="pageSearchChkReport" parameterType="checkReport" resultType="checkReport">
        select * from
        (
        select row_number() over() as rn,ui.user_name, cr.*, wr.facility_category , org.org_name, ar.org_area_name,ui.user_department
        from check_report cr join water_resources wr
        on cr.facility_code = wr.facility_code
        INNER JOIN org_area ar ON  wr.org_area =ar.org_area
        INNER JOIN ORGANIZATION org ON  wr.org_code =org.org_code
        INNER JOIN user_info ui ON  cr.user_id =ui.user_id
        where wr.facility_category like '%' || #{facility_category} || '%'
        and ar.org_area_name like '%' || #{org_area_name} || '%'
        and org.org_name like '%' || #{org_name} || '%'
        and ui.user_department like '%' || #{user_department} || '%'
        and cr.facility_code like '%' || #{facility_code} || '%'
        <choose>
            <when test="#{firstdate} == ''">
                and cr.check_date <= #{secdate}
            </when>
            <when test="#{secdate} == ''">
                and cr.check_date >= #{firstdate}
            </when>
            <otherwise>
                and cr.check_date between #{firstdate} and #{secdate}
            </otherwise>

        </choose>
        order by rn
        )
        offset #{start}-1 limit 10
    </select>

    <select id="cntSearchChkReport" parameterType="checkReport" resultType="checkReport">
        select count(*) as total from
        (
            select row_number() over() as rn,ui.user_name, cr.*, wr.facility_category , org.org_name, ar.org_area_name,ui.user_department
            from check_report cr join water_resources wr
            on cr.facility_code = wr.facility_code
            INNER JOIN org_area ar ON  wr.org_area =ar.org_area
            INNER JOIN ORGANIZATION org ON  wr.org_code =org.org_code
            INNER JOIN user_info ui ON  cr.user_id =ui.user_id
            where wr.facility_category like '%' || #{facility_category} || '%'
            and ar.org_area_name like '%' || #{org_area_name} || '%'
            and org.org_name like '%' || #{org_name} || '%'
            and ui.user_department like '%' || #{user_department} || '%'
            and cr.facility_code like '%' || #{facility_code} || '%'
            <choose>
                <when test="#{firstdate} == ''">
                    and cr.check_date <= #{secdate}
                </when>
                <when test="#{secdate} == ''">
                    and cr.check_date >= #{firstdate}
                </when>
                <otherwise>
                    and cr.check_date between #{firstdate} and #{secdate}
                </otherwise>

            </choose>
        )
    </select>

    <!--

        <insert id="inputChkReport" parameterType="checkReport">
            INSERT INTO check_report (
                doc_no, facility_code, check_date, weather, user_id,
                check_result, spec_memo, create_datetime, modify_datetime
            ) VALUES (
                         #{doc_no}, #{facility_code}, #{check_date},
                         #{weather}, #{user_id}, #{check_result}, #{spec_memo},
                         current_timestamp, null
                     )
        </insert>
    -->

</mapper>